name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v0.1.0)'
        required: true
        default: 'v0.1.0'
      all_platforms:
        description: 'Build for all platforms (including tier 2/3)'
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always

jobs:
  # ==========================================
  # Define the platform matrix
  # ==========================================
  
  # Tier 1 platforms - Guaranteed to work
  build-tier1:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            cross: false
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            cross: true
          # Linux ARM64
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            cross: true
          - target: aarch64-unknown-linux-musl
            os: ubuntu-latest
            cross: true
          # Linux ARM
          - target: armv7-unknown-linux-gnueabihf
            os: ubuntu-latest
            cross: true
          # macOS
          - target: x86_64-apple-darwin
            os: macos-latest
            cross: false
          - target: aarch64-apple-darwin
            os: macos-latest
            cross: false
          # Windows
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            cross: false
          - target: i686-pc-windows-msvc
            os: windows-latest
            cross: false
          - target: aarch64-pc-windows-msvc
            os: windows-latest
            cross: false
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Install cross (if needed)
        if: matrix.cross
        run: cargo install cross --locked
      
      - name: Build (native)
        if: ${{ !matrix.cross }}
        run: cargo build --release --target ${{ matrix.target }}
      
      - name: Build (cross)
        if: matrix.cross
        run: cross build --release --target ${{ matrix.target }}
      
      - name: Package (Unix)
        if: runner.os != 'Windows'
        run: |
          cd target/${{ matrix.target }}/release
          tar czvf ../../../govm-${{ matrix.target }}.tar.gz govm
          cd ../../..
      
      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd target/${{ matrix.target }}/release
          Compress-Archive -Path govm.exe -DestinationPath ../../../govm-${{ matrix.target }}.zip
          cd ../../..
      
      - name: Upload artifact (Unix)
        if: runner.os != 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: govm-${{ matrix.target }}
          path: govm-${{ matrix.target }}.tar.gz
          if-no-files-found: ignore
      
      - name: Upload artifact (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: govm-${{ matrix.target }}
          path: govm-${{ matrix.target }}.zip
          if-no-files-found: ignore

  # ==========================================
  # Tier 2/3 platforms - Best effort
  # ==========================================
  build-tier2:
    runs-on: ubuntu-latest
    if: github.event.inputs.all_platforms == 'true'
    strategy:
      fail-fast: false
      matrix:
        target:
          # More Linux architectures
          - i686-unknown-linux-gnu
          - i686-unknown-linux-musl
          - arm-unknown-linux-gnueabihf
          - arm-unknown-linux-musleabihf
          - thumbv7neon-unknown-linux-gnueabihf
          # MIPS
          - mips-unknown-linux-gnu
          - mipsel-unknown-linux-gnu
          - mips64-unknown-linux-gnuabi64
          - mips64el-unknown-linux-gnuabi64
          # PowerPC
          - powerpc-unknown-linux-gnu
          - powerpc64-unknown-linux-gnu
          - powerpc64le-unknown-linux-gnu
          # RISC-V
          - riscv64gc-unknown-linux-gnu
          # s390x (IBM Z)
          - s390x-unknown-linux-gnu
          # SPARC
          - sparc64-unknown-linux-gnu
          # LoongArch
          - loongarch64-unknown-linux-gnu
          # BSD
          - x86_64-unknown-freebsd
          - x86_64-unknown-netbsd
          # Android
          - aarch64-linux-android
          - armv7-linux-androideabi
          - x86_64-linux-android
          - i686-linux-android
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Install cross
        run: cargo install cross --locked
      
      - name: Build with cross
        run: cross build --release --target ${{ matrix.target }}
        continue-on-error: true
      
      - name: Package
        if: success()
        run: |
          cd target/${{ matrix.target }}/release
          tar czvf ../../../govm-${{ matrix.target }}.tar.gz govm
          cd ../../..
      
      - name: Upload artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: govm-${{ matrix.target }}
          path: govm-${{ matrix.target }}.tar.gz
          if-no-files-found: ignore

  # ==========================================
  # Create Release
  # ==========================================
  release:
    needs: [build-tier1, build-tier2]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true
      
      - name: List artifacts
        run: ls -la artifacts/
      
      - name: Generate checksums
        run: |
          cd artifacts
          sha256sum *.tar.gz *.zip 2>/dev/null > checksums.txt || true
          cat checksums.txt
          echo "Total packages: $(ls -1 *.tar.gz *.zip 2>/dev/null | wc -l)"
      
      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          name: Release ${{ steps.get_version.outputs.VERSION }}
          draft: false
          prerelease: false
          files: |
            artifacts/*.tar.gz
            artifacts/*.zip
            artifacts/checksums.txt
          body: |
            ## GoVM ${{ steps.get_version.outputs.VERSION }}

            Go Version Manager - 管理多版本 Go

            ### Installation

            Download the appropriate file for your platform and extract it:

            **Linux/macOS:**
            ```bash
            tar xzf govm-<target>.tar.gz
            sudo mv govm /usr/local/bin/
            ```

            **Windows:**
            ```powershell
            Expand-Archive -Path govm-<target>.zip -DestinationPath C:\path\to\bin
            ```

            ### Supported Platforms

            This release includes builds for Tier 1 platforms (guaranteed) and Tier 2/3 platforms (best effort).

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
